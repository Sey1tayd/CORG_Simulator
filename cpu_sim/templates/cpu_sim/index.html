<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16-bit CPU Pipeline Simulator</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%23000'/%3E%3Ctext x='8' y='11' font-size='8' text-anchor='middle' fill='%2358a6ff' font-family='Arial, sans-serif'%3ECPU%3C/text%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-0: #050505;
            --bg-1: #0d0f12;
            --bg-2: #11151a;
            --bg-3: #171c22;
            --panel: #0f1217;
            --border: #1f252d;
            --border-strong: #2a323d;
            --text-0: #e6edf3;
            --text-1: #9ca6b5;
            --text-2: #6e7a89;
            --accent: #58a6ff;
            --success: #3fb950;
            --warn: #d29922;
            --danger: #f85149;
            --cyan: #39d4e8;
            --if: #3b82f6;
            --id: #22c55e;
            --ex: #f59e0b;
            --mem: #a855f7;
            --wb: #ef4444;
            --shadow: 0 10px 50px rgba(0,0,0,0.4);
            --glow: 0 0 0 1px rgba(88,166,255,0.15), 0 10px 40px rgba(88,166,255,0.08);
            --r: 12px;
            --space: 14px;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at 20% 20%, rgba(88,166,255,0.04), transparent 30%),
                        radial-gradient(circle at 80% 0%, rgba(168,85,247,0.05), transparent 30%),
                        var(--bg-0);
            color: var(--text-0);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow: hidden;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-1); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-strong); }

        /* Top bar */
        .topbar {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 18px;
            padding: 16px 22px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(90deg, rgba(17,21,26,0.9), rgba(17,21,26,0.7));
            backdrop-filter: blur(6px);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            letter-spacing: 0.4px;
            color: var(--text-0);
        }
        .brand .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 6px rgba(88,166,255,0.1); }
        .brand small { color: var(--text-2); font-weight: 600; font-size: 11px; text-transform: uppercase; }

        .control-cluster {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .btn-group { display: inline-flex; gap: 6px; background: var(--bg-2); padding: 6px; border: 1px solid var(--border); border-radius: var(--r); }
        button {
            border: 1px solid transparent;
            background: var(--bg-1);
            color: var(--text-1);
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            letter-spacing: 0.2px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }
        button:hover { color: var(--text-0); border-color: var(--border); background: var(--bg-2); }
        button:active { transform: translateY(1px); }
        button.primary { background: var(--accent); color: #031325; border-color: rgba(255,255,255,0.08); box-shadow: var(--glow); }
        button.primary:hover { background: #6eb4ff; }
        button.success { background: var(--success); color: #041006; }
        button.success:hover { background: #48c25d; }
        button.danger { background: rgba(248,81,73,0.1); border-color: var(--danger); color: var(--danger); }
        button.danger:hover { background: rgba(248,81,73,0.15); }

        .speed {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--r);
            background: var(--bg-1);
        }
        .speed label { font-size: 11px; color: var(--text-2); text-transform: uppercase; letter-spacing: 0.5px; }
        .speed .value { font-family: 'JetBrains Mono', monospace; color: var(--accent); }
        input[type=range] { width: 130px; accent-color: var(--accent); }

        .connection-pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-1);
            color: var(--text-1);
            font-weight: 600;
        }
        .connection-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--text-2); box-shadow: 0 0 0 6px rgba(255,255,255,0.03); }
        .connection-pill.connected .connection-dot { background: var(--success); box-shadow: 0 0 0 6px rgba(63,185,80,0.15); }
        .connection-pill.reconnecting .connection-dot { background: var(--warn); box-shadow: 0 0 0 6px rgba(210,153,34,0.15); }
        .connection-pill.error .connection-dot { background: var(--danger); box-shadow: 0 0 0 6px rgba(248,81,73,0.12); }

        /* Layout */
        .layout {
            display: grid;
            grid-template-columns: 1.2fr 1.1fr 0.9fr;
            grid-template-rows: calc(100vh - 120px);
            gap: 14px;
            padding: 14px 18px 18px;
            height: calc(100vh - 72px);
        }
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--r);
            display: flex;
            flex-direction: column;
            min-height: 0;
            box-shadow: var(--shadow);
        }
        .panel-head {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .panel-title { font-weight: 700; letter-spacing: 0.2px; color: var(--text-0); }
        .panel-sub { color: var(--text-2); font-size: 12px; }
        .panel-body { padding: 12px; flex: 1; overflow: hidden; display: flex; flex-direction: column; gap: 10px; }

        /* Tabs */
        .tabs { display: flex; gap: 8px; }
        .tab {
            padding: 10px 12px;
            border-radius: 10px;
            background: var(--bg-2);
            color: var(--text-2);
            cursor: pointer;
            border: 1px solid var(--border);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
        }
        .tab.active { color: var(--accent); border-color: var(--border-strong); box-shadow: var(--glow); }

        /* Editor */
        .editor-shell { display: flex; gap: 0; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--bg-1); height: 100%; }
        .line-numbers { width: 60px; background: var(--bg-2); color: var(--text-2); font-family: 'JetBrains Mono', monospace; padding: 16px 10px; text-align: right; overflow-y: auto; border-right: 1px solid var(--border); }
        .line-number { min-height: 22px; display: block; position: relative; }
        .line-number.error::before { content: '•'; color: var(--danger); position: absolute; left: -10px; font-size: 12px; }
        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-0);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            padding: 16px;
            resize: none;
            outline: none;
            line-height: 1.7;
            tab-size: 4;
        }
        .machine-code-list { border: 1px solid var(--border); border-radius: 12px; background: var(--bg-1); overflow: auto; flex: 1; }
        .machine-code-item { padding: 12px 14px; border-bottom: 1px solid var(--border); }
        .machine-code-item:last-child { border-bottom: none; }
        .machine-code-item.current { background: rgba(88,166,255,0.08); border-left: 3px solid var(--accent); }
        .mc-header { display: flex; gap: 12px; align-items: center; font-family: 'JetBrains Mono', monospace; }
        .mc-pc { color: var(--text-2); min-width: 32px; }
        .mc-hex { color: var(--cyan); font-weight: 700; }
        .mc-binary { color: var(--text-2); font-size: 12px; }
        .mc-asm { margin-top: 6px; color: var(--text-0); font-family: 'JetBrains Mono', monospace; }
        .mc-format { color: var(--text-2); font-size: 11px; margin-top: 6px; font-family: 'JetBrains Mono', monospace; display: flex; flex-wrap: wrap; gap: 4px; }
        .field-name { color: var(--text-2); font-size: 10px; }
        .field-value { color: var(--text-1); }

        /* Timeline */
        .timeline-shell { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--bg-1); flex: 1; display: flex; flex-direction: column; }
        .timeline-wrapper { flex: 1; overflow: auto; }
        table { border-collapse: separate; border-spacing: 4px; width: max-content; min-width: 100%; color: var(--text-1); }
        th, td { background: var(--bg-2); padding: 8px; border-radius: 8px; text-align: center; font-size: 11px; }
        th { position: sticky; top: 0; z-index: 10; font-weight: 700; color: var(--text-2); }
        th:first-child { position: sticky; left: 0; z-index: 11; text-align: left; background: var(--bg-3); }
        td:first-child { position: sticky; left: 0; z-index: 9; text-align: left; font-family: 'JetBrains Mono', monospace; background: var(--bg-3); min-width: 180px; }
        tr:hover td { background: var(--bg-2); }
        tr:hover td:first-child { background: var(--bg-3); }
        .stage-cell { display: inline-block; padding: 6px 10px; border-radius: 10px; font-weight: 700; letter-spacing: 0.4px; color: var(--text-0); }
        .stage-if { background: rgba(59,130,246,0.18); color: var(--if); border: 1px solid rgba(59,130,246,0.5); }
        .stage-id { background: rgba(34,197,94,0.18); color: var(--id); border: 1px solid rgba(34,197,94,0.5); }
        .stage-ex { background: rgba(245,158,11,0.2); color: var(--ex); border: 1px solid rgba(245,158,11,0.5); }
        .stage-mem { background: rgba(168,85,247,0.2); color: var(--mem); border: 1px solid rgba(168,85,247,0.5); }
        .stage-wb { background: rgba(239,68,68,0.2); color: var(--wb); border: 1px solid rgba(239,68,68,0.5); }

        /* Cards */
        .stack { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .card { background: var(--bg-2); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
        .card h4 { margin: 0 0 6px; color: var(--text-2); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .value { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--text-0); }
        .value.accent { color: var(--accent); }
        .value.warn { color: var(--warn); }
        .value.danger { color: var(--danger); }
        .grid-two { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
        .grid-three { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px; }

        .stage-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .stage-box { background: var(--bg-2); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
        .stage-name { font-weight: 700; color: var(--text-2); letter-spacing: 0.4px; }
        .stage-instr { margin-top: 6px; color: var(--text-0); font-family: 'JetBrains Mono', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stage-box.active { border-color: var(--accent); box-shadow: var(--glow); }

        /* Registers & Memory */
        .list { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
        .list-item { background: var(--bg-2); border: 1px solid var(--border); border-radius: 10px; padding: 10px; display: flex; justify-content: space-between; align-items: center; font-family: 'JetBrains Mono', monospace; }
        .list-item.modified { border-color: rgba(63,185,80,0.4); background: rgba(63,185,80,0.08); color: var(--success); }
        .memory-list .list-item { grid-column: span 2; }

        /* Status & tooltip */
        #status { position: fixed; bottom: 18px; right: 20px; background: var(--bg-2); border: 1px solid var(--border); padding: 12px 16px; border-radius: 10px; display: none; box-shadow: var(--shadow); z-index: 20; }
        #status.success { border-color: rgba(63,185,80,0.6); color: var(--success); }
        #status.error { border-color: rgba(248,81,73,0.5); color: var(--danger); }

        .tooltip { position: fixed; background: var(--bg-3); border: 1px solid var(--border); padding: 12px; border-radius: 10px; box-shadow: var(--shadow); display: none; z-index: 30; min-width: 220px; }
        .tooltip-title { font-weight: 700; color: var(--text-0); margin-bottom: 8px; }
        .tooltip-row { display: flex; justify-content: space-between; color: var(--text-1); font-size: 12px; margin: 2px 0; }

        /* Error panel */
        .error-panel { position: fixed; bottom: 18px; left: 18px; width: 360px; max-height: 440px; background: var(--bg-2); border: 1px solid var(--danger); border-radius: 12px; box-shadow: var(--shadow); display: none; flex-direction: column; overflow: hidden; z-index: 25; }
        .error-panel.visible { display: flex; }
        .error-panel-header { padding: 12px 14px; background: rgba(248,81,73,0.12); color: var(--danger); display: flex; align-items: center; justify-content: space-between; }
        .error-panel-content { padding: 10px; overflow: auto; }
        .error-item { padding: 10px; background: var(--bg-3); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
        .error-item:hover { border-color: var(--danger); }
        .error-message { color: var(--text-0); font-weight: 600; }
        .error-source { color: var(--text-2); font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-top: 6px; }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="brand">
            <span class="dot"></span>
            <div>
                <div>16-bit CPU Simulator</div>
                <small>5 aşamalı boruhattı</small>
            </div>
        </div>
        <div class="control-cluster">
            <div class="btn-group">
                <button id="btn-compile" title="Assembly'i makine koduna derle">⌘ Derle</button>
                <button id="btn-assemble" class="primary" title="CPU'ya yükle">⬇ Yükle</button>
            </div>
            <div class="btn-group">
                <button id="btn-step" title="Tek adım">→ Step</button>
                <button id="btn-run" class="success" title="Sürekli çalıştır">▶ Çalıştır</button>
                <button id="btn-pause" title="Duraklat">⏸ Duraklat</button>
            </div>
            <div class="btn-group">
                <button id="btn-reset" class="danger" title="Sıfırla">↻ Reset</button>
            </div>
            <div class="speed">
                <label>Hız</label>
                <input type="range" id="hz-slider" min="1" max="100" value="10">
                <span class="value"><span id="hz-value">10</span> Hz</span>
            </div>
        </div>
        <div class="connection-pill reconnecting" id="connection-pill">
            <span class="connection-dot"></span>
            <span id="connection-label">Bağlanıyor…</span>
        </div>
    </header>

    <main class="layout">
        <!-- Code Panel -->
        <section class="panel" id="code-panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">Kod</div>
                    <div class="panel-sub">Assembly düzenle veya makine kodunu incele</div>
                </div>
                <div class="tabs">
                    <div class="tab active code-tab" data-tab="assembly">Assembly</div>
                    <div class="tab code-tab" data-tab="machine">Makine Kodu</div>
                </div>
            </div>
            <div class="panel-body" id="code-content">
                <div class="assembly-editor-wrapper" style="display:flex; flex:1; min-height:0;">
                    <div class="editor-shell">
                        <div class="line-numbers" id="line-numbers"></div>
                        <textarea id="assembly-editor" spellcheck="false" placeholder="# Assembly kodunu yazın\n# R-Type: add, sub, and, or, xor, slt, div\n# I-Type: addi, lw, sw, beq, j, jal, jr"># Örnek Program: Sayı Toplama
addi r1, r0, 5
addi r2, r0, 3
add r3, r1, r2
sw r3, 0(r0)
lw r4, 0(r0)
sub r5, r3, r2</textarea>
                    </div>
                </div>
                <div class="machine-code-list" id="machine-code-list" style="display:none;"></div>
            </div>
        </section>

        <!-- Timeline Panel -->
        <section class="panel" id="timeline-panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">Pipeline Zaman Çizelgesi</div>
                    <div class="panel-sub">16 sütunluk kayan pencere</div>
                </div>
                <div class="panel-sub">Döngü: <span id="header-cycle">0</span> · PC: <span id="header-pc">0x0000</span></div>
            </div>
            <div class="panel-body">
                <div class="timeline-shell">
                    <div class="timeline-wrapper" id="timeline-wrapper">
                        <table id="timeline-table">
                            <thead id="timeline-header">
                                <tr>
                                    <th>Instr</th>
                                    <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th>
                                </tr>
                            </thead>
                            <tbody id="timeline-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Insight & Registers -->
        <section class="panel" id="insights-panel">
            <div class="panel-head">
                <div class="panel-title">Durum ve Çıkışlar</div>
                <div class="panel-sub">Kontrol, kısadevre ve kayıt bilgisi</div>
            </div>
            <div class="panel-body" style="gap:12px;">
                <div class="stage-row">
                    <div class="stage-box" id="stage-if">
                        <div class="stage-name" style="color:var(--if);">IF</div>
                        <div class="stage-instr" id="if-instr">—</div>
                    </div>
                    <div class="stage-box" id="stage-id">
                        <div class="stage-name" style="color:var(--id);">ID</div>
                        <div class="stage-instr" id="id-instr">—</div>
                    </div>
                    <div class="stage-box" id="stage-ex">
                        <div class="stage-name" style="color:var(--ex);">EX</div>
                        <div class="stage-instr" id="ex-instr">—</div>
                    </div>
                    <div class="stage-box" id="stage-mem">
                        <div class="stage-name" style="color:var(--mem);">MEM</div>
                        <div class="stage-instr" id="mem-instr">—</div>
                    </div>
                    <div class="stage-box" id="stage-wb">
                        <div class="stage-name" style="color:var(--wb);">WB</div>
                        <div class="stage-instr" id="wb-instr">—</div>
                    </div>
                </div>

                <div class="grid-three">
                    <div class="card" id="hz-instr-item" style="display:none; grid-column: span 3;">
                        <h4>Seçili Talimat</h4>
                        <div class="value" id="hz-instr">—</div>
                    </div>
                    <div class="card" id="hz-stall-item">
                        <h4>Stall</h4><div class="value" id="hz-stall">NO</div>
                    </div>
                    <div class="card" id="hz-fwd-a-item">
                        <h4>Forward A</h4><div class="value" id="hz-fwd-a">00</div>
                    </div>
                    <div class="card" id="hz-fwd-b-item">
                        <h4>Forward B</h4><div class="value" id="hz-fwd-b">00</div>
                    </div>
                    <div class="card" id="hz-pcsrc-item">
                        <h4>PC Kaynağı</h4><div class="value" id="hz-pcsrc">0</div>
                    </div>
                    <div class="card" id="hz-zero-item">
                        <h4>ALU Zero</h4><div class="value" id="hz-zero">0</div>
                    </div>
                    <div class="card" id="hz-flush-item">
                        <h4>Flush</h4><div class="value" id="hz-flush">NO</div>
                    </div>
                </div>

                <div class="grid-two">
                    <div class="card" style="grid-column: span 2;">
                        <h4>Kontrol Sinyalleri (ID/EX)</h4>
                        <div class="stack">
                            <div class="value" id="ctrl-regdst" data-label="RegDst">0 RegDst</div>
                            <div class="value" id="ctrl-alusrc" data-label="ALUSrc">0 ALUSrc</div>
                            <div class="value" id="ctrl-memtoreg" data-label="MemToReg">0 MemToReg</div>
                            <div class="value" id="ctrl-regwrite" data-label="RegWrite">0 RegWrite</div>
                            <div class="value" id="ctrl-memread" data-label="MemRead">0 MemRead</div>
                            <div class="value" id="ctrl-memwrite" data-label="MemWrite">0 MemWrite</div>
                            <div class="value" id="ctrl-branch" data-label="Branch">0 Branch</div>
                            <div class="value" id="ctrl-jump" data-label="Jump">0 Jump</div>
                        </div>
                    </div>
                    <div class="card" style="grid-column: span 2;">
                        <h4>Kayıtlar</h4>
                        <div class="list" id="reg-grid"></div>
                    </div>
                    <div class="card" style="grid-column: span 2;">
                        <h4>Veri Hafızası</h4>
                        <div class="list memory-list" id="mem-list"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="status"></div>
    <div class="tooltip" id="tooltip"></div>

    <div class="error-panel" id="error-panel">
        <div class="error-panel-header">
            <div><strong id="error-count">0</strong> hata</div>
            <button class="danger" id="error-panel-close" style="padding:6px 10px;">Kapat</button>
        </div>
        <div class="error-panel-content" id="error-panel-content">
            <div id="error-list"></div>
        </div>
    </div>

    <script>
        class CPUSimulator {
            constructor() {
                this.ws = null;
                this.reconnectTimer = null;
                this.state = null;
                this.compiledMachineCode = null;
                this.errorLines = new Set();
                this.activeTab = 'assembly';
                this.selectedInstrPC = null;
                this.selectedInstrData = null;
                this.init();
            }

            init() {
                this.cacheElements();
                this.bindControls();
                this.setupTabs();
                this.setupLineNumbers();
                this.initRegisters();
                this.connectWebSocket();
            }

            cacheElements() {
                this.lineNumbers = document.getElementById('line-numbers');
                this.editor = document.getElementById('assembly-editor');
                this.machineCodeList = document.getElementById('machine-code-list');
                this.timelineBody = document.getElementById('timeline-body');
                this.timelineHeader = document.getElementById('timeline-header');
                this.timelineWrapper = document.getElementById('timeline-wrapper');
                this.tooltip = document.getElementById('tooltip');
                this.status = document.getElementById('status');
            }

            bindControls() {
                document.getElementById('btn-compile').addEventListener('click', () => this.handleCompile());
                document.getElementById('btn-assemble').addEventListener('click', () => this.handleAssemble());
                document.getElementById('btn-step').addEventListener('click', () => this.handleStep());
                document.getElementById('btn-run').addEventListener('click', () => this.handleRun());
                document.getElementById('btn-pause').addEventListener('click', () => this.send({ cmd: 'pause' }));
                document.getElementById('btn-reset').addEventListener('click', () => this.handleReset());
                document.getElementById('hz-slider').addEventListener('input', (e) => {
                    document.getElementById('hz-value').textContent = e.target.value;
                });
            }

            setupTabs() {
                document.querySelectorAll('.code-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.activeTab = tab.dataset.tab;
                        this.toggleCodeViews();
                    });
                });
            }

            toggleCodeViews() {
                const editorWrap = document.querySelector('.assembly-editor-wrapper');
                if (this.activeTab === 'assembly') {
                    editorWrap.style.display = 'flex';
                    this.machineCodeList.style.display = 'none';
                } else {
                    editorWrap.style.display = 'none';
                    this.machineCodeList.style.display = 'block';
                    if (!this.compiledMachineCode && this.editor.value.trim()) {
                        this.send({ cmd: 'compile', assembly: this.editor.value });
                    } else {
                        this.updateMachineCode();
                    }
                }
            }

            setupLineNumbers() {
                if (!this.editor || !this.lineNumbers) return;
                const sync = () => { this.lineNumbers.scrollTop = this.editor.scrollTop; };
                this.editor.addEventListener('input', () => this.updateLineNumbers());
                this.editor.addEventListener('scroll', sync);
                this.lineNumbers.addEventListener('scroll', () => { this.editor.scrollTop = this.lineNumbers.scrollTop; });
                this.editor.addEventListener('paste', () => setTimeout(() => this.updateLineNumbers(), 10));
                this.updateLineNumbers();
            }

            updateLineNumbers() {
                if (!this.editor || !this.lineNumbers) return;
                const lines = this.editor.value.split('\n');
                this.lineNumbers.innerHTML = '';
                lines.forEach((_, idx) => {
                    const num = idx + 1;
                    const div = document.createElement('div');
                    div.className = 'line-number';
                    if (this.errorLines.has(num)) div.classList.add('error');
                    div.textContent = num;
                    this.lineNumbers.appendChild(div);
                });
                this.lineNumbers.scrollTop = this.editor.scrollTop;
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/cpu/`;
                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    if (this.reconnectTimer) clearTimeout(this.reconnectTimer);
                    this.setConnectionStatus('connected');
                    this.setControlsDisabled(false);
                    this.showStatus('CPU bağlantısı kuruldu', 'success');
                };

                this.ws.onclose = () => {
                    this.setConnectionStatus('reconnecting');
                    this.setControlsDisabled(true);
                    if (!this.reconnectTimer) {
                        this.reconnectTimer = setTimeout(() => {
                            this.reconnectTimer = null;
                            this.connectWebSocket();
                        }, 2000);
                    }
                };

                this.ws.onerror = () => {
                    this.setConnectionStatus('error');
                };

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };
            }

            handleCompile() {
                const code = this.editor.value;
                if (!code.trim()) {
                    this.showStatus('Derlenecek kod yok', 'error');
                    return;
                }
                this.send({ cmd: 'compile', assembly: code });
                this.showStatus('Derleniyor...', '');
            }

            handleAssemble() {
                const code = this.editor.value;
                if (!code.trim()) {
                    this.showStatus('Yüklenecek kod yok', 'error');
                    return;
                }
                if (this.timelineBody) this.timelineBody.innerHTML = '';
                this.send({ cmd: 'load_program', assembly: code });
                this.showStatus('Program CPU\'ya yüklendi', 'success');
                setTimeout(() => document.querySelector('.code-tab[data-tab="machine"]').click(), 150);
            }

            handleStep() {
                if (this.selectedInstrPC !== null) {
                    this.send({ cmd: 'step', from_pc: this.selectedInstrPC });
                    this.showStatus(`PC ${this.selectedInstrPC} için step`, '');
                } else {
                    this.send({ cmd: 'step' });
                }
            }

            handleRun() {
                const hz = parseInt(document.getElementById('hz-slider').value, 10);
                this.send({ cmd: 'run', hz });
            }

            handleReset() {
                this.send({ cmd: 'reset' });
                if (this.machineCodeList) this.machineCodeList.innerHTML = '';
                this.compiledMachineCode = null;
                this.selectedInstrPC = null;
                this.selectedInstrData = null;
                this.clearErrorLines();
                this.hideErrors();
                this.showStatus('Sıfırlandı', '');
            }

            send(data) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(data));
                }
            }

            handleMessage(data) {
                if (data.type === 'state') {
                    this.state = data;
                    this.updateUI();
                    if (this.activeTab === 'machine') this.updateMachineCode();
                } else if (data.type === 'compile_result') {
                    this.compiledMachineCode = data.machine_code;
                    if (!this.activeTab || this.activeTab === 'assembly') {
                        document.querySelector('.code-tab[data-tab="machine"]').click();
                    }
                    if (data.has_errors) {
                        this.showErrors(data.errors || []);
                        this.markErrorLines(data.errors || []);
                        this.showStatus('Derleme hatası', 'error');
                    } else {
                        this.hideErrors();
                        this.clearErrorLines();
                        this.showStatus('Derleme başarılı', 'success');
                    }
                    this.updateMachineCode();
                } else if (data.type === 'error') {
                    if (data.errors && data.errors.length) {
                        this.showErrors(data.errors);
                        this.markErrorLines(data.errors);
                    }
                    this.showStatus(data.message || 'Hata', 'error');
                }
            }

            updateUI() {
                if (!this.state) return;
                this.updateHeader();
                this.updatePipelineDiagram();
                this.updateHazards();
                this.updateControlSignals();
                this.updateRegisters();
                this.updateMemory();
                this.updateTimeline();
                this.updateMachineCode();
                if (this.selectedInstrPC !== null) this.updateSelectedInstructionInfo();
            }

            updateHeader() {
                document.getElementById('header-cycle').textContent = this.state.cycle;
                document.getElementById('header-pc').textContent = '0x' + this.state.pc.toString(16).toUpperCase().padStart(4, '0');
            }

            updatePipelineDiagram() {
                const stages = ['if','id','ex','mem','wb'];
                const info = this.state.stage_info;
                const regs = this.state.pipeline_regs;

                document.getElementById('if-instr').textContent = info.if?.asm || 'nop';
                document.getElementById('id-instr').textContent = info.id?.asm || 'nop';
                document.getElementById('ex-instr').textContent = regs.id_ex.ctrl && regs.id_ex.ctrl !== '00000000' ? (info.ex?.asm || 'nop') : '—';
                document.getElementById('mem-instr').textContent = regs.ex_mem.ctrl && regs.ex_mem.ctrl !== '00000000' ? (info.mem?.asm || 'nop') : '—';
                document.getElementById('wb-instr').textContent = regs.mem_wb.ctrl && regs.mem_wb.ctrl !== '00000000' ? (info.wb?.asm || 'nop') : '—';

                stages.forEach((stage, idx) => {
                    const box = document.getElementById(`stage-${stage}`);
                    if (this.state.cycle > idx) box.classList.add('active'); else box.classList.remove('active');
                });
            }

            updateHazards() {
                const hazards = this.state.hazards;
                const info = this.state.stage_info;
                let stageForSelection = null;
                if (this.selectedInstrPC !== null) {
                    const start = this.selectedInstrPC + 1;
                    const c = this.state.cycle;
                    if (c >= start + 4) stageForSelection = 'WB';
                    else if (c >= start + 3) stageForSelection = 'MEM';
                    else if (c >= start + 2) stageForSelection = 'EX';
                    else if (c >= start + 1) stageForSelection = 'ID';
                    else if (c >= start) stageForSelection = 'IF';
                }
                const show = (id, value, active) => {
                    const el = document.getElementById(id);
                    el.textContent = value;
                    el.className = 'value' + (active ? ' warn' : '');
                };

                if (stageForSelection === 'ID' || !stageForSelection) {
                    show('hz-stall', hazards.stall ? 'YES' : 'NO', hazards.stall);
                    document.getElementById('hz-stall-item').classList.toggle('warn', hazards.stall);
                } else { show('hz-stall', '—', false); document.getElementById('hz-stall-item').classList.remove('warn'); }

                const fwdA = hazards.forward_a;
                const fwdB = hazards.forward_b;
                const zero = info.ex?.zero;
                const flush = hazards.flush_ifid || hazards.flush_idex;

                if (stageForSelection === 'EX' || !stageForSelection) {
                    show('hz-fwd-a', fwdA, fwdA !== '00');
                    show('hz-fwd-b', fwdB, fwdB !== '00');
                } else {
                    show('hz-fwd-a', '—', false);
                    show('hz-fwd-b', '—', false);
                }

                if (stageForSelection === 'IF' || stageForSelection === 'ID' || !stageForSelection) {
                    show('hz-pcsrc', hazards.pc_src ? '1' : '0', hazards.pc_src);
                    show('hz-flush', flush ? 'YES' : 'NO', flush);
                } else {
                    show('hz-pcsrc', '—', false);
                    show('hz-flush', '—', false);
                }

                if (stageForSelection === 'EX' || !stageForSelection) {
                    show('hz-zero', zero ? '1' : '0', zero);
                } else {
                    show('hz-zero', '—', false);
                }

                if (this.selectedInstrPC !== null) this.updateSelectedInstructionInfo();
            }

            updateSelectedInstructionInfo() {
                const item = document.getElementById('hz-instr-item');
                const display = document.getElementById('hz-instr');
                if (this.selectedInstrPC === null) { item.style.display = 'none'; return; }

                let instr = null; let fullAsm = null;
                if (this.state?.instr_mem?.[this.selectedInstrPC]) {
                    instr = this.state.instr_mem[this.selectedInstrPC];
                    fullAsm = instr.asm;
                } else if (this.selectedInstrData) {
                    instr = this.selectedInstrData;
                    fullAsm = instr.asm;
                } else if (this.compiledMachineCode) {
                    const mc = this.compiledMachineCode.find(m => (m.pc ?? m.line - 1) === this.selectedInstrPC);
                    if (mc && !mc.error) { instr = { hex: mc.hex, asm: mc.asm || '----' }; fullAsm = mc.asm; }
                }
                if (!fullAsm) {
                    const lines = this.editor.value.split('\n');
                    const idx = this.selectedInstrPC;
                    if (lines[idx]) fullAsm = lines[idx].split('#')[0].trim();
                }
                if (!instr) { item.style.display = 'none'; return; }
                item.style.display = 'block';
                display.innerHTML = `<span class="value" style="color:var(--cyan);">PC ${this.selectedInstrPC}</span> · <span style="color:var(--accent);">${instr.hex}</span> · <span style="font-family:'JetBrains Mono', monospace;">${fullAsm || instr.asm || '----'}</span>`;
            }

            updateControlSignals() {
                const ctrlStr = this.state.pipeline_regs.id_ex.ctrl || '00000000';
                const ctrl = parseInt(ctrlStr, 2) || 0;
                const names = ['regdst','alusrc','memtoreg','regwrite','memread','memwrite','branch','jump'];
                names.forEach((name, idx) => {
                    const val = (ctrl >> idx) & 1;
                    const el = document.getElementById(`ctrl-${name}`);
                    const suffix = el.dataset.label ? ` ${el.dataset.label}` : '';
                    el.textContent = `${val}${suffix}`;
                    el.className = 'value' + (val ? ' accent' : '');
                });
            }

            updateRegisters() {
                const grid = document.getElementById('reg-grid');
                grid.innerHTML = '';
                this.state.regfile.forEach(reg => {
                    const div = document.createElement('div');
                    div.className = 'list-item' + (reg.v !== 0 ? ' modified' : '');
                    div.innerHTML = `<span>r${reg.r}</span><span>${reg.v}</span>`;
                    grid.appendChild(div);
                });
            }

            updateMemory() {
                const list = document.getElementById('mem-list');
                const data = this.state.data_mem.sort((a,b) => a.addr - b.addr);
                if (data.length === 0) {
                    list.innerHTML = '<div class="panel-sub">Veri yok</div>';
                    return;
                }
                list.innerHTML = '';
                data.forEach(mem => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `<span>[${mem.addr}]</span><span style="color:var(--cyan);">${mem.v}</span>`;
                    list.appendChild(div);
                });
            }

            updateMachineCode() {
                if (!this.machineCodeList) return;
                let code = null;
                if (this.compiledMachineCode?.length) {
                    code = this.compiledMachineCode;
                } else if (this.state?.instr_mem?.length) {
                    code = this.state.instr_mem.map(instr => ({
                        line: instr.pc + 1,
                        hex: instr.hex,
                        binary: parseInt(instr.hex, 16).toString(2).padStart(16,'0'),
                        value: parseInt(instr.hex, 16),
                        asm: instr.asm,
                        pc: instr.pc
                    }));
                }
                if (!code || code.length === 0) {
                    this.machineCodeList.innerHTML = '<div style="padding:16px; color:var(--text-2);">Derlenen kodu görmek için COMPILE tıklayın</div>';
                    return;
                }
                this.machineCodeList.innerHTML = code.slice(0, 120).map(mc => {
                    if (mc.blank) return '';
                    if (mc.error || (mc.value === null && !mc.blank)) {
                        return `<div class="machine-code-item" style="opacity:0.6;"><div class="mc-asm" style="color:var(--danger);">Satır ${mc.line}: Geçersiz</div></div>`;
                    }
                    const isCurrent = this.state && mc.pc !== undefined && mc.pc === this.state.pc;
                    const binary = mc.binary || mc.value.toString(2).padStart(16,'0');
                    const format = this.formatInstruction(binary, (mc.value >> 12) & 0xF);
                    const pcDisplay = mc.pc !== undefined ? mc.pc : (mc.line - 1);
                    return `<div class="machine-code-item${isCurrent ? ' current' : ''}">
                        <div class="mc-header"><span class="mc-pc">${pcDisplay}</span><span class="mc-hex">${mc.hex}</span><span class="mc-binary">${binary}</span></div>
                        <div class="mc-asm">${mc.asm || '----'}</div>
                        ${format}
                    </div>`;
                }).join('');
            }

            formatInstruction(binary, opcode) {
                if (opcode === 0x0) {
                    return `<div class="mc-format">
                        <span class="field-value">${binary.substring(0,4)}</span><span class="field-name">op</span>
                        <span class="field-value">${binary.substring(4,7)}</span><span class="field-name">rs</span>
                        <span class="field-value">${binary.substring(7,10)}</span><span class="field-name">rt</span>
                        <span class="field-value">${binary.substring(10,13)}</span><span class="field-name">rd</span>
                        <span class="field-value">${binary.substring(13,16)}</span><span class="field-name">func</span>
                    </div>`;
                } else if (opcode === 0x5 || opcode === 0x6) {
                    return `<div class="mc-format">
                        <span class="field-value">${binary.substring(0,4)}</span><span class="field-name">op</span>
                        <span class="field-value">${binary.substring(4,16)}</span><span class="field-name">imm12</span>
                    </div>`;
                }
                return `<div class="mc-format">
                    <span class="field-value">${binary.substring(0,4)}</span><span class="field-name">op</span>
                    <span class="field-value">${binary.substring(4,7)}</span><span class="field-name">rs</span>
                    <span class="field-value">${binary.substring(7,10)}</span><span class="field-name">rt</span>
                    <span class="field-value">${binary.substring(10,16)}</span><span class="field-name">imm6</span>
                </div>`;
            }

            updateTimeline() {
                const VISIBLE_COLUMNS = 16;
                const tbody = this.timelineBody;
                const thead = this.timelineHeader;
                const currentCycle = this.state?.cycle || 0;
                let instrDataList = [];
                let maxInstrPC = -1;

                if (this.state?.instr_mem?.length) {
                    this.state.instr_mem.forEach((instr, i) => {
                        if (instr && instr.hex !== '0000') {
                            instrDataList.push({ pc: i, hex: instr.hex, asm: instr.asm, value: parseInt(instr.hex,16) });
                            maxInstrPC = i;
                        }
                    });
                }
                if (instrDataList.length === 0 && this.compiledMachineCode?.length) {
                    this.compiledMachineCode.forEach((mc, i) => {
                        if (mc && !mc.error && mc.value !== null) {
                            const pc = mc.pc !== undefined ? mc.pc : i;
                            instrDataList.push({ pc, hex: mc.hex, asm: mc.asm || '----', value: mc.value });
                            maxInstrPC = Math.max(maxInstrPC, pc);
                        }
                    });
                }
                if (!instrDataList.length) {
                    tbody.innerHTML = '<tr><td colspan="17" style="padding:20px; color:var(--text-2);">Zaman çizelgesi için program yükleyin</td></tr>';
                    return;
                }

                let windowStart = currentCycle <= 14 ? 1 : currentCycle - 13;
                const minCycle = 1;
                const maxCycle = Math.max(windowStart + VISIBLE_COLUMNS - 1, currentCycle + 5, maxInstrPC + 10);

                if (thead) {
                    const row = thead.querySelector('tr');
                    row.innerHTML = '<th>Instr</th>';
                    for (let c = minCycle; c <= maxCycle; c++) {
                        const th = document.createElement('th');
                        th.textContent = c;
                        th.id = `cycle-header-${c}`;
                        if (c === currentCycle) th.style.color = 'var(--accent)';
                        row.appendChild(th);
                    }
                }

                tbody.innerHTML = '';
                const instructions = {};
                instrDataList.forEach(instr => {
                    const start = instr.pc + 1;
                    instructions[instr.pc] = {};
                    if (start <= currentCycle) instructions[instr.pc][start] = 'IF';
                    if (start + 1 <= currentCycle) instructions[instr.pc][start + 1] = 'ID';
                    if (start + 2 <= currentCycle) instructions[instr.pc][start + 2] = 'EX';
                    if (start + 3 <= currentCycle) instructions[instr.pc][start + 3] = 'MEM';
                    if (start + 4 <= currentCycle) instructions[instr.pc][start + 4] = 'WB';
                });

                instrDataList.forEach(instr => {
                    const row = document.createElement('tr');
                    const asmText = instr.asm.length > 22 ? instr.asm.slice(0,22) + '…' : instr.asm;
                    let cells = `<td class="instr-row-header" data-pc="${instr.pc}" style="cursor:pointer;">
                        <div style="display:flex; gap:6px; align-items:center;">
                            <span class="value" style="color:var(--text-2);">${instr.pc}</span>
                            <span style="color:var(--cyan);">${instr.hex}</span>
                            <span style="color:var(--text-1);">${asmText}</span>
                        </div>
                    </td>`;
                    for (let c = minCycle; c <= maxCycle; c++) {
                        const stage = instructions[instr.pc]?.[c];
                        if (stage) cells += `<td><span class="stage-cell stage-${stage.toLowerCase()}" data-pc="${instr.pc}" data-cycle="${c}" data-stage="${stage}">${stage}</span></td>`;
                        else cells += '<td></td>';
                    }
                    row.innerHTML = cells;
                    const header = row.querySelector('.instr-row-header');
                    header.addEventListener('click', () => {
                        this.selectInstruction(instr.pc, instr);
                    });
                    if (this.selectedInstrPC === instr.pc) {
                        header.style.background = 'var(--bg-3)';
                        header.style.borderLeft = '3px solid var(--accent)';
                    }
                    tbody.appendChild(row);
                });

                setTimeout(() => {
                    if (!this.timelineWrapper) return;
                    const target = document.getElementById(`cycle-header-${windowStart}`);
                    if (target) {
                        const left = target.offsetLeft - 150;
                        const diff = Math.abs(this.timelineWrapper.scrollLeft - left);
                        if (diff > 40 || currentCycle <= 14) {
                            this.timelineWrapper.scrollTo({ left: Math.max(0, left), behavior: 'smooth' });
                        }
                    }
                }, 40);

                this.addTooltipListeners();
            }

            addTooltipListeners() {
                document.querySelectorAll('#timeline-table .stage-cell[data-stage]').forEach(cell => {
                    const clone = cell.cloneNode(true);
                    cell.parentNode.replaceChild(clone, cell);
                    clone.addEventListener('mouseenter', (e) => {
                        const pc = parseInt(clone.dataset.pc, 10);
                        const cycle = parseInt(clone.dataset.cycle, 10);
                        const stage = clone.dataset.stage;
                        let instr = null;
                        if (this.state?.instr_mem?.[pc]) instr = this.state.instr_mem[pc];
                        else if (this.compiledMachineCode) {
                            const mc = this.compiledMachineCode.find(m => (m.pc ?? m.line - 1) === pc);
                            if (mc && !mc.error) instr = { hex: mc.hex, asm: mc.asm || '----' };
                        }
                        if (!instr) return;
                        let content = `<div class="tooltip-title">Cycle ${cycle} — ${stage}</div>`;
                        content += `<div class="tooltip-row"><span>PC</span><span>${pc}</span></div>`;
                        content += `<div class="tooltip-row"><span>Hex</span><span>${instr.hex}</span></div>`;
                        content += `<div class="tooltip-row"><span>Instr</span><span>${instr.asm}</span></div>`;
                        if (stage === 'EX' && this.state?.stage_info?.ex) {
                            content += `<div class="tooltip-row"><span>Forward A</span><span>${this.state.hazards.forward_a}</span></div>`;
                            content += `<div class="tooltip-row"><span>Forward B</span><span>${this.state.hazards.forward_b}</span></div>`;
                        }
                        this.tooltip.innerHTML = content;
                        this.tooltip.style.display = 'block';
                        const rect = clone.getBoundingClientRect();
                        let left = rect.right + 12;
                        let top = rect.top;
                        if (left + 240 > window.innerWidth) left = rect.left - 240;
                        if (top + 180 > window.innerHeight) top = window.innerHeight - 190;
                        this.tooltip.style.left = `${left}px`;
                        this.tooltip.style.top = `${top}px`;
                    });
                    clone.addEventListener('mouseleave', () => { this.tooltip.style.display = 'none'; });
                });
            }

            selectInstruction(pc, instrData) {
                this.selectedInstrPC = pc;
                this.selectedInstrData = instrData;
                document.querySelectorAll('.instr-row-header').forEach(header => {
                    header.style.background = '';
                    header.style.borderLeft = '';
                    if (parseInt(header.dataset.pc, 10) === pc) {
                        header.style.background = 'var(--bg-3)';
                        header.style.borderLeft = '3px solid var(--accent)';
                    }
                });
                this.updateSelectedInstructionInfo();
            }

            setConnectionStatus(state) {
                const pill = document.getElementById('connection-pill');
                const label = document.getElementById('connection-label');
                pill.classList.remove('connected','reconnecting','error');
                if (state === 'connected') { pill.classList.add('connected'); label.textContent = 'Bağlandı'; }
                else if (state === 'reconnecting') { pill.classList.add('reconnecting'); label.textContent = 'Yeniden bağlanıyor…'; }
                else if (state === 'error') { pill.classList.add('error'); label.textContent = 'Bağlantı hatası'; }
                else { pill.classList.add('reconnecting'); label.textContent = 'Bağlanıyor…'; }
            }

            setControlsDisabled(disabled) {
                document.querySelectorAll('button, #hz-slider').forEach(ctrl => {
                    ctrl.disabled = disabled;
                    ctrl.style.opacity = disabled ? 0.5 : 1;
                    ctrl.style.cursor = disabled ? 'not-allowed' : 'pointer';
                });
            }

            showStatus(message, type='') {
                this.status.textContent = message;
                this.status.className = type;
                this.status.style.display = 'block';
                setTimeout(() => this.status.style.display = 'none', 2500);
            }

            showErrors(errors) {
                const panel = document.getElementById('error-panel');
                const list = document.getElementById('error-list');
                const count = document.getElementById('error-count');
                count.textContent = errors.length;
                panel.classList.add('visible');
                list.innerHTML = '';
                errors.forEach(error => {
                    const div = document.createElement('div');
                    div.className = 'error-item';
                    const line = error.line || 0;
                    div.innerHTML = `<div class="error-message">Satır ${line}: ${this.escapeHtml(error.message || 'Hata')}</div>` +
                                    (error.source ? `<div class="error-source">${this.escapeHtml(error.source)}</div>` : '');
                    div.addEventListener('click', () => this.scrollToLine(line));
                    list.appendChild(div);
                });
                document.getElementById('error-panel-close').onclick = () => this.hideErrors();
            }

            hideErrors() {
                document.getElementById('error-panel').classList.remove('visible');
            }

            markErrorLines(errors) {
                this.errorLines = new Set(errors.filter(e => e.line).map(e => e.line));
                this.updateLineNumbers();
            }

            clearErrorLines() {
                this.errorLines = new Set();
                this.updateLineNumbers();
            }

            scrollToLine(line) {
                if (!this.editor) return;
                const lines = this.editor.value.split('\n');
                let idx = 0;
                for (let i = 0; i < line - 1 && i < lines.length; i++) idx += lines[i].length + 1;
                this.editor.focus();
                this.editor.setSelectionRange(idx, idx);
                const lineHeight = 20;
                this.editor.scrollTop = Math.max(0, (line - 1) * lineHeight - 80);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        document.addEventListener('DOMContentLoaded', () => { window.cpuSim = new CPUSimulator(); });
    </script>
</body>
</html>
